<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stock Receipt Management</title>

<style>
:root {
  --primary: #4361ee;
  --primary-light: #5a75f5;
  --secondary: #3f37c9;
  --success: #4cc9f0;
  --danger: #f72585;
  --danger-light: #f94c9c;
  --warning: #ffb74d;
  --info: #64b5f6;
  --bg: #f8f9fc;
  --card-bg: #ffffff;
  --text: #2b2d42;
  --text-light: #8d99ae;
  --text-lighter: #adb5bd;
  --border: #eef0f4;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
}

* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 20px 20px 25px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
}

.header h1 {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.header p {
  opacity: 0.9;
  font-size: 14px;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
  padding-bottom: 80px; /* Space for floating button */
}

/* Page Transitions */
.page {
  display: none;
  animation: fadeIn 0.3s ease-out;
}

.page.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Search Bar */
.search-container {
  background: white;
  border-radius: var(--radius-md);
  padding: 15px 20px;
  margin: -15px auto 20px;
  box-shadow: var(--shadow);
  position: relative;
  z-index: 10;
  max-width: 95%;
}

.search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.search-icon {
  position: absolute;
  left: 15px;
  color: var(--text-light);
  font-size: 18px;
}

#searchBox {
  width: 100%;
  padding: 14px 45px 14px 45px;
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 16px;
  background: #fafbff;
  transition: all 0.3s ease;
}

#searchBox:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.clear-search {
  position: absolute;
  right: 15px;
  background: none;
  border: none;
  color: var(--text-lighter);
  font-size: 22px;
  cursor: pointer;
  display: none;
}

.clear-search:hover {
  color: var(--danger);
}

/* Table Styles */
.table-container {
  background: white;
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

thead {
  background: linear-gradient(to right, #f8faff, #f0f5ff);
}

th {
  padding: 18px 16px;
  text-align: left;
  font-weight: 600;
  color: var(--secondary);
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
}

td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

tr:last-child td {
  border-bottom: none;
}

tr:hover {
  background-color: rgba(67, 97, 238, 0.03);
}

/* Button Styles */
.btn {
  padding: 12px 20px;
  border-radius: var(--radius-md);
  border: none;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-decoration: none;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 14px;
}

.btn:active {
  transform: scale(0.98);
}

.btn-primary {
  background: linear-gradient(to right, var(--primary), var(--primary-light));
  color: white;
}

.btn-primary:hover {
  background: linear-gradient(to right, var(--primary-light), #6a80f8);
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.btn-secondary {
  background: #f1f5f9;
  color: var(--text);
}

.btn-secondary:hover {
  background: #e8eff8;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.btn-danger {
  background: linear-gradient(to right, #ffeef0, #ffe8ec);
  color: var(--danger);
  border: 1px solid #ffdfe4;
}

.btn-danger:hover {
  background: linear-gradient(to right, #ffe8ec, #ffdfe4);
  box-shadow: 0 4px 12px rgba(247, 37, 133, 0.2);
}

.btn-success {
  background: linear-gradient(to right, #e8f7ff, #e0f4ff);
  color: var(--success);
  border: 1px solid #c2ebff;
}

.btn-success:hover {
  background: linear-gradient(to right, #e0f4ff, #d8f1ff);
  box-shadow: 0 4px 12px rgba(76, 201, 240, 0.2);
}

/* Detail Cards */
.details-container {
  background: white;
  border-radius: var(--radius-md);
  padding: 20px;
  margin-bottom: 25px;
  box-shadow: var(--shadow);
}

.detail-card {
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.detail-card:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.detail-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.detail-value {
  font-size: 16px;
  font-weight: 500;
  color: var(--text);
  word-break: break-word;
}

/* Link button for receipt */
.view-file-btn {
  margin-top: 8px;
  background: linear-gradient(to right, #eef2ff, #e8edff);
  color: var(--primary);
  border: 1px solid #dbe1ff;
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s ease;
}

.view-file-btn:hover {
  background: linear-gradient(to right, #e8edff, #e0e7ff);
  box-shadow: 0 2px 8px rgba(67, 97, 238, 0.2);
  transform: translateY(-1px);
}

/* Form Styles */
.form-container {
  background: white;
  border-radius: var(--radius-md);
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: var(--shadow);
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-weight: 600;
  color: var(--secondary);
  margin-bottom: 8px;
  font-size: 14px;
}

.form-input, .form-select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 16px;
  background: #fafbff;
  transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.form-input[readonly] {
  background-color: #f9fafc;
  color: var(--text-light);
  cursor: not-allowed;
  border-color: #e2e7f0;
}

/* Button Groups */
.button-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.button-group .btn {
  flex: 1;
  min-width: 140px;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.modal-content {
  background: white;
  width: 90%;
  max-width: 450px;
  margin: 15vh auto;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.4s ease-out;
  overflow: hidden;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  padding: 20px 25px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
}

.modal-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.modal-body {
  padding: 25px;
  color: var(--text);
  line-height: 1.6;
}

.modal-footer {
  padding: 20px 25px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* Loader */
.loader {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: 1100;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.loader-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid rgba(67, 97, 238, 0.1);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 50px 20px;
  color: var(--text-light);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

/* Floating Action Button */
.floating-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  cursor: pointer;
  z-index: 100;
  transition: all 0.3s ease;
}

.floating-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 10px 30px rgba(67, 97, 238, 0.5);
}

/* Supplier Selection Popup */
.supplier-popup {
  max-width: 500px;
  max-height: 70vh;
  display: flex;
  flex-direction: column;
}

.supplier-search-container {
  padding: 15px 25px;
  border-bottom: 1px solid var(--border);
  background: #f8faff;
}

.supplier-search-wrapper {
  position: relative;
}

.supplier-search-wrapper .search-icon {
  left: 12px;
}

.supplier-search {
  width: 100%;
  padding: 12px 40px 12px 40px;
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 16px;
  background: white;
}

.supplier-search:focus {
  outline: none;
  border-color: var(--primary);
}

.supplier-list-container {
  flex: 1;
  overflow-y: auto;
  max-height: 300px;
}

.supplier-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.supplier-item {
  padding: 15px 25px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 12px;
}

.supplier-item:hover {
  background: rgba(67, 97, 238, 0.05);
}

.supplier-item.selected {
  background: rgba(67, 97, 238, 0.1);
  border-left: 4px solid var(--primary);
}

.supplier-item:last-child {
  border-bottom: none;
}

.supplier-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(67, 97, 238, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary);
  font-weight: bold;
}

.supplier-name {
  font-weight: 500;
  color: var(--text);
}

.supplier-empty {
  padding: 40px 20px;
  text-align: center;
  color: var(--text-light);
}

/* Add Form Modal */
.add-form-modal {
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
}

.form-header {
  padding: 20px 25px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(to right, #f8faff, #f0f5ff);
}

.form-header h3 {
  color: var(--secondary);
  margin: 0;
}

.form-body {
  padding: 25px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.form-footer {
  padding: 20px 25px;
  border-top: 1px solid var(--border);
  background: #f8faff;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* File Upload Styling */
.file-upload-wrapper {
  position: relative;
  overflow: hidden;
  display: inline-block;
  width: 100%;
}

.file-upload-wrapper input[type=file] {
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.file-upload-btn {
  background: linear-gradient(to right, #eef2ff, #e8edff);
  color: var(--primary);
  border: 2px dashed #dbe1ff;
  padding: 40px 20px;
  border-radius: var(--radius-md);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.3s ease;
  text-align: center;
}

.file-upload-btn:hover {
  background: linear-gradient(to right, #e8edff, #e0e7ff);
  border-color: var(--primary);
}

.file-preview {
  margin-top: 10px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: var(--radius-sm);
  font-size: 14px;
  color: var(--text-light);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .container {
    padding: 15px;
    padding-bottom: 80px;
  }
  
  .header {
    padding: 18px 15px 22px;
  }
  
  .header h1 {
    font-size: 22px;
  }
  
  .search-container {
    padding: 12px 15px;
    margin: -12px auto 15px;
  }
  
  #searchBox {
    padding: 12px 45px 12px 45px;
  }
  
  .button-group {
    flex-direction: column;
  }
  
  .button-group .btn {
    width: 100%;
    min-width: auto;
  }
  
  .modal-content {
    width: 95%;
    margin: 10vh auto;
  }
  
  .modal-footer {
    flex-direction: column;
  }
  
  .modal-footer .btn {
    width: 100%;
  }
  
  .form-container {
    padding: 20px;
  }
  
  .details-container {
    padding: 16px;
  }
  
  .floating-btn {
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    font-size: 26px;
  }
  
  .add-form-modal {
    width: 95%;
    max-height: 85vh;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 600px) {
  .table-responsive {
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
  }
  
  table {
    min-width: 100%;
  }
  
  th, td {
    padding: 12px 10px;
    font-size: 14px;
  }
  
  .supplier-popup {
    width: 95%;
  }
}

/* Supplier modal should be highest when open from add form */
#supplierModal {
  z-index: 1200;
}

/* When supplier modal is open from add form, 
   make add form modal appear behind */
.modal-open #addFormModal {
  z-index: 900;
}

.modal-open #supplierModal {
  z-index: 1200;
}
</style>
</head>
<body>

<div class="header">
  <h1>Stock Receipt Management</h1>
  <p>Track and manage your stock receipts efficiently</p>
</div>

<div class="search-container" id="searchContainer">
  <div class="search-wrapper">
    <div class="search-icon">üîç</div>
    <input type="text" id="searchBox" placeholder="Search supplier, amount, or any field..." onkeyup="filterPage1()">
    <button class="clear-search" onclick="clearSearch()">√ó</button>
  </div>
</div>

<div class="container">
  
  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="loader-spinner"></div>
    <p>Loading data...</p>
  </div>

  <!-- PAGE 1: Supplier List -->
  <div class="page active" id="page1">
    <div class="table-container">
      <div class="table-responsive">
        <table id="page1Table">
          <thead>
            <tr>
              <th>Supplier</th>
              <th>Amount (‚Çπ)</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-icon">üì¶</div>
      <h3>No records found</h3>
      <p>Try adjusting your search criteria</p>
    </div>
  </div>

  <!-- PAGE 2: Details -->
  <div class="page" id="page2">
    <div class="details-container">
      <h3 style="margin-bottom: 20px; color: var(--secondary);">Entry Details</h3>
      <div id="detailsContainer"></div>
    </div>
    
    <div class="button-group">
      <button class="btn btn-primary" onclick="goToPage3()">
        <span>‚úèÔ∏è</span> Edit Record
      </button>
      <button class="btn btn-danger" onclick="openDeletePopup()">
        <span>üóëÔ∏è</span> Delete
      </button>
      <button class="btn btn-secondary" onclick="goToPage1()">
        <span>‚Üê</span> Back to List
      </button>
    </div>
  </div>

  <!-- PAGE 3: Edit -->
  <div class="page" id="page3">
    <div class="form-container">
      <h3 style="margin-bottom: 20px; color: var(--secondary);">Edit Record</h3>
      <form id="editForm">
        <div id="editFields"></div>
        
        <div class="button-group">
          <button type="submit" class="btn btn-primary">
            <span>üíæ</span> Save Changes
          </button>
          <button type="button" class="btn btn-secondary" onclick="goToPage2()">
            <span>‚úï</span> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Floating Action Button -->
<button class="floating-btn" id="addFloatingBtn" onclick="openAddFormModal()">
  +
</button>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon" style="background: rgba(247, 37, 133, 0.1); color: var(--danger);">
        ‚ö†Ô∏è
      </div>
      <h3>Delete Record</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this record? This action cannot be undone and will permanently remove the entry from the system.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeletePopup()">Cancel</button>
      <button class="btn btn-danger" onclick="deleteRow()">Delete</button>
    </div>
  </div>
</div>

<!-- Message Alert Modal -->
<div class="modal" id="messageModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon" id="messageIcon" style="background: rgba(76, 201, 240, 0.1); color: var(--success);">
        ‚úì
      </div>
      <h3 id="messageTitle">Success</h3>
    </div>
    <div class="modal-body">
      <p id="messageText">Operation completed successfully.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeMessageModal()">OK</button>
    </div>
  </div>
</div>

<!-- Supplier Selection Popup -->
<div class="modal" id="supplierModal">
  <div class="modal-content supplier-popup">
    <div class="modal-header">
      <div class="modal-icon" style="background: rgba(67, 97, 238, 0.1); color: var(--primary);">
        üë•
      </div>
      <h3>Select Supplier</h3>
    </div>
    
    <div class="supplier-search-container">
      <div class="supplier-search-wrapper">
        <div class="search-icon">üîç</div>
        <input type="text" class="supplier-search" id="supplierSearch" placeholder="Search supplier name...">
      </div>
    </div>
    
    <div class="supplier-list-container">
      <ul class="supplier-list" id="supplierList">
        <!-- Supplier items will be populated here -->
      </ul>
      <div class="supplier-empty" id="supplierEmpty" style="display: none;">
        <div style="font-size: 36px; margin-bottom: 10px;">üîç</div>
        <p>No suppliers found</p>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSupplierModal()">Cancel</button>
      <button class="btn btn-primary" onclick="selectSupplier()">Select</button>
    </div>
  </div>
</div>

<!-- Add Form Modal -->
<div class="modal" id="addFormModal">
  <div class="modal-content add-form-modal">
    <div class="form-header">
      <h3>Add New Stock Receipt</h3>
    </div>
    
    <form id="stockForm">
      <div class="form-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Academic Year</label>
            <input type="text" class="form-input" id="academicYear" readonly>
          </div>
          
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" id="date" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Name of Supplier *</label>
            <div class="form-input supplier-select-trigger" id="supplierSelectTrigger" onclick="openSupplierModalForForm()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
              <span id="selectedSupplierText">Select Supplier</span>
              <span>‚ñº</span>
            </div>
            <input type="hidden" id="supplierSelect" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Product Name *</label>
            <input type="text" class="form-input" id="productName" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">GST Number *</label>
            <input type="text" class="form-input" id="gstNumber" maxlength="15" required
                   placeholder="Format: 12XXXXXXXXXXXXX"
                   pattern="^[0-9]{2}[A-Z0-9]{13}$"
				   oninput="this.value = this.value.toUpperCase()"
                   title="GST must start with 2 numbers, followed by 13 uppercase letters or numbers">
          </div>
          
          <div class="form-group">
            <label class="form-label">GST % *</label>
            <select class="form-select" id="gstPercent" required>
              <option value="">Select GST %</option>
              <option value="0">0%</option>
              <option value="5">5%</option>
              <option value="18">18%</option>
              <option value="40">40%</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Total Amount (‚Çπ) *</label>
            <input type="number" class="form-input" id="totalAmount" min="0" step="0.01" required>
          </div>
		  
		  <div class="form-group">
            <label class="form-label">Expenses Amount (‚Çπ) *</label>
            <input type="number" class="form-input" id="expensesAmount" min="0" step="0.01" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Note</label>
            <textarea class="form-input" id="note" rows="3" style="resize: vertical;"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Receipt *</label>
            <div class="file-upload-wrapper">
              <input type="file" id="receiptFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" Required>
              <div class="file-upload-btn">
                <div style="font-size: 24px;">üìé</div>
                <div>Click to upload receipt</div>
                <div style="font-size: 12px; opacity: 0.7;">PDF, JPG, PNG, DOC up to 5MB</div>
              </div>
            </div>
            <div class="file-preview" id="filePreview" style="display: none;"></div>
          </div>
        </div>
      </div>
      
      <div class="form-footer">
        <button type="button" class="btn btn-secondary" onclick="closeAddFormModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Submit Receipt</button>
      </div>
    </form>
  </div>
</div>

<script>
/*******************************
 * CONFIG
 *******************************/
const scriptUrl = "https://script.google.com/macros/s/AKfycbyOr17M5Ve_vjmQmp6H5cQGUEd9mO8OUW1pRh7T0Y6jI3ietFf001FQVVpVwGec-pHvAQ/exec";
const CONFIG = {
  spreadsheetId: "1VE6K0AaTdQLBGtMnYEtEAHCH7xcfPN-BeZoIKV8OifI",
  dataSheet: "Stock Receipt",
  supplierSheet: "Suplier Info",
  supplierHeader: "Supplier Name",
  driveFolderId: "1WZsddDn3-D6b_9dnUJ_pQjg42aSuwCuR"
};

let allData = [];
let allSuppliers = [];
let selectedRow = null;
let selectedRowData = null;
let filteredData = [];
let currentSelectedSupplier = null;
let currentSupplierModalTarget = null; // 'edit' or 'add'

/*******************************
 * PAGE ELEMENTS
 *******************************/
const page1 = document.getElementById("page1");
const page2 = document.getElementById("page2");
const page3 = document.getElementById("page3");
const tableBody = document.querySelector("#page1Table tbody");
const loader = document.getElementById("loader");
const detailsContainer = document.getElementById("detailsContainer");
const editFields = document.getElementById("editFields");
const searchBox = document.getElementById("searchBox");
const clearSearchBtn = document.querySelector(".clear-search");
const emptyState = document.getElementById("emptyState");

/*******************************
 * MESSAGE/ALERT SYSTEM
 *******************************/
function showMessage(title, message, type = 'success') {
  const modal = document.getElementById('messageModal');
  const icon = document.getElementById('messageIcon');
  const messageTitle = document.getElementById('messageTitle');
  const messageText = document.getElementById('messageText');
  
  // Set styles based on message type
  if (type === 'success') {
    icon.style.background = 'rgba(76, 201, 240, 0.1)';
    icon.style.color = 'var(--success)';
    icon.textContent = '‚úì';
  } else if (type === 'error') {
    icon.style.background = 'rgba(247, 37, 133, 0.1)';
    icon.style.color = 'var(--danger)';
    icon.textContent = '‚úï';
  } else if (type === 'warning') {
    icon.style.background = 'rgba(255, 183, 77, 0.1)';
    icon.style.color = 'var(--warning)';
    icon.textContent = '‚ö†Ô∏è';
  } else if (type === 'info') {
    icon.style.background = 'rgba(100, 181, 246, 0.1)';
    icon.style.color = 'var(--info)';
    icon.textContent = '‚ÑπÔ∏è';
  }
  
  messageTitle.textContent = title;
  messageText.textContent = message;
  modal.style.display = 'block';
}

function closeMessageModal() {
  document.getElementById('messageModal').style.display = 'none';
}

/*******************************
 * LOAD DATA
 *******************************/
function loadData() {
  loader.style.display = 'flex';
  Promise.all([loadAllData(), loadSuppliers()])
    .then(() => {
      loader.style.display = 'none';
      updateEmptyState();
    })
    .catch(err => {
      loader.style.display = 'none';
      showMessage('Connection Error', 'Failed to load data. Please check your connection and try again.', 'error');
      console.error(err);
    });
}

function loadAllData() {
  return fetch(`${scriptUrl}?action=getAllData&spreadsheetId=${CONFIG.spreadsheetId}&dataSheet=${CONFIG.dataSheet}`)
    .then(res => res.json())
    .then(data => { 
      allData = data;
      filteredData = allData.slice(1);
      renderPage1();
    })
    .catch(err => {
      throw err;
    });
}

function loadSuppliers() {
  return fetch(`${scriptUrl}?action=getSuppliers&spreadsheetId=${CONFIG.spreadsheetId}&supplierSheet=${CONFIG.supplierSheet}&supplierHeader=${CONFIG.supplierHeader}`)
    .then(res => res.json())
    .then(data => {
      allSuppliers = data;
      populateSupplierModal();
    })
    .catch(err => {
      console.error('Failed to load suppliers:', err);
      allSuppliers = [];
      populateSupplierModal();
    });
}

/*******************************
 * PAGE 1: SUPPLIER LIST
 *******************************/
function renderPage1() {
  tableBody.innerHTML = "";
  
  filteredData.forEach((row, index) => {
    const originalIndex = allData.findIndex(r => r === row);
    const tr = document.createElement("tr");
    
    // Format date if present
    let dateDisplay = row[1] || '-';
    if (row[1]) {
      const date = new Date(row[1]);
      if (!isNaN(date.getTime())) {
        dateDisplay = date.toLocaleDateString('en-IN', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric' 
        });
      }
    }
    
    // Format amount
    const amount = parseFloat(row[6]) || 0;
    const formattedAmount = new Intl.NumberFormat('en-IN', {
      maximumFractionDigits: 0
    }).format(amount);
    
    tr.innerHTML = `
      <td>${row[2] || 'N/A'}</td>
      <td>‚Çπ${formattedAmount}</td>
      <td>${dateDisplay}</td>
      <td>
        <button class="btn btn-sm btn-success" onclick="showDetails(${originalIndex})">
          <span>üëÅÔ∏è</span> View
        </button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
  
  updateEmptyState();
}

function filterPage1() {
  const q = searchBox.value.toLowerCase().trim();
  
  // Show/hide clear button
  clearSearchBtn.style.display = q.length > 0 ? 'block' : 'none';
  
  if (q === '') {
    filteredData = allData.slice(1);
  } else {
    filteredData = allData.slice(1).filter(row => {
      return row.some(cell => 
        String(cell).toLowerCase().includes(q)
      );
    });
  }
  
  renderPage1();
}

function clearSearch() {
  searchBox.value = '';
  clearSearchBtn.style.display = 'none';
  filterPage1();
}

function updateEmptyState() {
  if (filteredData.length === 0) {
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
  }
}

/*******************************
 * PAGE 2: DETAILS
 *******************************/
function showDetails(index) {
  selectedRow = index + 1;
  selectedRowData = allData[index];
  
  detailsContainer.innerHTML = "";
  const headers = allData[0];
  
  headers.forEach((h, i) => {
    const div = document.createElement("div");
    div.classList.add("detail-card");
    
    const label = document.createElement("div");
    label.className = "detail-label";
    label.textContent = h;
    
    const value = document.createElement("div");
    value.className = "detail-value";
    
    let cellValue = selectedRowData[i] || '-';
    
    // Format dates
    if (h.toLowerCase().includes('date') && cellValue !== '-') {
      const date = new Date(cellValue);
      if (!isNaN(date.getTime())) {
        cellValue = date.toLocaleDateString('en-IN', { 
          weekday: 'short',
          day: '2-digit', 
          month: 'short', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    }
    
    // Format amounts
    if ((h.toLowerCase().includes('amount') || h.toLowerCase().includes('total') || h.toLowerCase().includes('rate')) && cellValue !== '-') {
      const num = parseFloat(cellValue);
      if (!isNaN(num)) {
        cellValue = '‚Çπ' + new Intl.NumberFormat('en-IN', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        }).format(num);
      }
    }
    
    value.textContent = cellValue;
    
    div.appendChild(label);
    div.appendChild(value);
    
    // Check if this is a receipt field and contains a link
    const headerLower = h.toLowerCase();
    const valueLower = String(selectedRowData[i] || '').toLowerCase();
    if ((headerLower.includes('receipt') || headerLower.includes('bill') || headerLower.includes('file') || 
         headerLower.includes('url') || headerLower.includes('link')) && 
        (valueLower.includes('http://') || valueLower.includes('https://') || 
         valueLower.includes('.pdf') || valueLower.includes('.doc') || 
         valueLower.includes('.jpg') || valueLower.includes('.png'))) {
      
      // Only show "View File" button, not the actual link
      const linkBtn = document.createElement("a");
      linkBtn.href = selectedRowData[i];
      linkBtn.target = "_blank";
      linkBtn.rel = "noopener noreferrer";
      linkBtn.className = "view-file-btn";
      linkBtn.innerHTML = '<span>üìÑ</span> View File';
      
      div.appendChild(linkBtn);
    }
    
    detailsContainer.appendChild(div);
  });
  
  showPage(2);
}

/*******************************
 * PAGE 3: EDIT
 *******************************/
function goToPage3() {
  editFields.innerHTML = "";
  const headers = allData[0];
  
  selectedRowData.forEach((value, i) => {
    const formGroup = document.createElement("div");
    formGroup.className = "form-group";
    
    const label = document.createElement("label");
    label.className = "form-label";
    label.textContent = headers[i];
    label.htmlFor = `edit-field-${i}`;
    
    formGroup.appendChild(label);
    
    const headerLower = headers[i].toLowerCase();
    const isReadOnly = headerLower.includes("academic") || 
                      headerLower.includes("date") || 
                      headerLower.includes("receipt") ||
                      headerLower.includes("bill no");
    
    // Supplier dropdown - replaced with clickable field
    if (headerLower.includes("supplier") || headerLower.includes("name of supplier")) {
      const supplierTrigger = document.createElement("div");
      supplierTrigger.className = "form-input supplier-select-trigger";
      supplierTrigger.id = "editSupplierTrigger";
      supplierTrigger.style.cursor = "pointer";
      supplierTrigger.style.display = "flex";
      supplierTrigger.style.justifyContent = "space-between";
      supplierTrigger.style.alignItems = "center";
      
      const supplierText = document.createElement("span");
      supplierText.id = "editSupplierText";
      supplierText.textContent = value || "Select Supplier";
      
      const dropdownIcon = document.createElement("span");
      dropdownIcon.textContent = "‚ñº";
      
      supplierTrigger.appendChild(supplierText);
      supplierTrigger.appendChild(dropdownIcon);
      
      supplierTrigger.onclick = function() {
        currentSupplierModalTarget = 'edit';
        currentSelectedSupplier = value;
        openSupplierModal();
      };
      
      // Hidden input to store the actual value
      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.id = `edit-field-${i}`;
      hiddenInput.name = headers[i];
      hiddenInput.value = value || '';
      
      formGroup.appendChild(supplierTrigger);
      formGroup.appendChild(hiddenInput);
    } 
    // Read-only fields (Academic Year, Date, Receipt)
    else if (isReadOnly) {
      const input = document.createElement("input");
      input.type = "text";
      input.className = "form-input";
      input.id = `edit-field-${i}`;
      input.name = headers[i];
      input.value = value || '';
      input.readOnly = true;
      formGroup.appendChild(input);
    }
    // Numeric fields
    else if (headerLower.includes("amount") || headerLower.includes("rate") || 
             headerLower.includes("qty") || headerLower.includes("quantity") || 
             headerLower.includes("total")) {
      const input = document.createElement("input");
      input.type = "number";
      input.className = "form-input";
      input.id = `edit-field-${i}`;
      input.name = headers[i];
      input.value = value || '';
      input.step = "0.01";
      input.min = "0";
      formGroup.appendChild(input);
    }
    // Text fields
    else {
      const input = document.createElement("input");
      input.type = "text";
      input.className = "form-input";
      input.id = `edit-field-${i}`;
      input.name = headers[i];
      input.value = value || '';
      formGroup.appendChild(input);
    }
    
    editFields.appendChild(formGroup);
  });
  
  showPage(3);
}

// Submit update
document.getElementById("editForm").addEventListener("submit", function(e){
  e.preventDefault();
  const inputs = editFields.querySelectorAll("input, select");
  const updatedRow = Array.from(inputs).map(i => i.value);
  
  loader.style.display = 'flex';
  fetch(scriptUrl, {
    method: "POST",
    body: JSON.stringify({
      action: "update",
      spreadsheetId: CONFIG.spreadsheetId,
      dataSheet: CONFIG.dataSheet,
      rowNumber: selectedRow,
      updatedRow: updatedRow
    })
  })
    .then(res => res.json())
    .then(() => {
      loader.style.display = 'none';
      showMessage('Success', 'Record updated successfully!', 'success');
      loadData();
      // Go back to details page after successful update
      setTimeout(() => {
        showDetails(selectedRow - 1);
      }, 500);
    })
    .catch(err => {
      loader.style.display = 'none';
      showMessage('Update Failed', 'Failed to update record. Please try again.', 'error');
      console.error(err);
    });
});

/*******************************
 * SUPPLIER SELECTION POPUP
 *******************************/
function populateSupplierModal() {
  const supplierList = document.getElementById('supplierList');
  const supplierSearch = document.getElementById('supplierSearch');
  
  function renderSuppliers(filter = '') {
    supplierList.innerHTML = '';
    
    const filteredSuppliers = allSuppliers.filter(supplier => 
      supplier.toLowerCase().includes(filter.toLowerCase())
    );
    
    if (filteredSuppliers.length === 0) {
      document.getElementById('supplierEmpty').style.display = 'block';
      return;
    }
    
    document.getElementById('supplierEmpty').style.display = 'none';
    
    filteredSuppliers.forEach(supplier => {
      const li = document.createElement('li');
      li.className = 'supplier-item';
      if (supplier === currentSelectedSupplier) {
        li.classList.add('selected');
      }
      
      // Get initials for avatar
      const initials = supplier.split(' ')
        .map(word => word.charAt(0))
        .join('')
        .toUpperCase()
        .substring(0, 2);
      
      li.innerHTML = `
        <div class="supplier-icon">${initials}</div>
        <div class="supplier-name">${supplier}</div>
      `;
      
      li.onclick = function() {
        // Remove selected class from all items
        document.querySelectorAll('.supplier-item').forEach(item => {
          item.classList.remove('selected');
        });
        // Add selected class to clicked item
        li.classList.add('selected');
        currentSelectedSupplier = supplier;
      };
      
      supplierList.appendChild(li);
    });
  }
  
  // Initial render
  renderSuppliers();
  
  // Search functionality
  supplierSearch.addEventListener('input', function() {
    renderSuppliers(this.value);
  });
}

function openSupplierModal() {
  document.getElementById('supplierModal').style.display = 'block';
  // Refresh supplier list
  populateSupplierModal();
}

function openSupplierModalForForm() {
  currentSupplierModalTarget = 'add';
  
  // Add class to body for modal stacking
  document.body.classList.add('modal-open');
  
  openSupplierModal();
}

function closeSupplierModal() {
  document.getElementById('supplierModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

function closeAddFormModal() {
  document.getElementById('addFormModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

function selectSupplier() {
  if (!currentSelectedSupplier) {
    showMessage('Selection Required', 'Please select a supplier first.', 'warning');
    return;
  }
  
  if (currentSupplierModalTarget === 'edit') {
    // Update the edit form
    document.getElementById('editSupplierText').textContent = currentSelectedSupplier;
    document.querySelector('#editFields input[type="hidden"]').value = currentSelectedSupplier;
  } else if (currentSupplierModalTarget === 'add') {
    // Update the add form
    document.getElementById('selectedSupplierText').textContent = currentSelectedSupplier;
    document.getElementById('supplierSelect').value = currentSelectedSupplier;
  }
  
  closeSupplierModal();
}

/*******************************
 * ADD FORM MODAL
 *******************************/
function openAddFormModal() {
  // Auto-fill academic year
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth() + 1;
  const academicYear = month >= 4 ? `${year}-${year+1}` : `${year-1}-${year}`;
  
  document.getElementById('academicYear').value = academicYear;
  document.getElementById('date').value = today.toISOString().split('T')[0];
  
  // Reset form
  document.getElementById('selectedSupplierText').textContent = 'Select Supplier';
  document.getElementById('supplierSelect').value = '';
  document.getElementById('productName').value = '';
  document.getElementById('gstNumber').value = '';
  document.getElementById('gstPercent').value = '';
  document.getElementById('totalAmount').value = '';
  document.getElementById('expensesAmount').value = '';
  document.getElementById('note').value = '';
  document.getElementById('receiptFile').value = '';
  document.getElementById('filePreview').style.display = 'none';
  document.getElementById('filePreview').textContent = '';
  
  currentSelectedSupplier = null;
  
  document.getElementById('addFormModal').style.display = 'block';
}

function closeAddFormModal() {
  document.getElementById('addFormModal').style.display = 'none';
}

// File upload preview
document.getElementById('receiptFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const filePreview = document.getElementById('filePreview');
  
  if (file) {
    filePreview.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    filePreview.style.display = 'block';
  } else {
    filePreview.style.display = 'none';
  }
});

// Add form submission
document.getElementById('stockForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
// Get GST value and force uppercase
const gstInput = document.getElementById('gstNumber');
const gstNumber = gstInput.value.trim().toUpperCase();

// Update input field so user also sees uppercase
gstInput.value = gstNumber;

// Validate GST pattern
const gstRegex = /^[0-9]{2}[A-Z0-9]{13}$/;

if (!gstRegex.test(gstNumber)) {
  showMessage(
    'Invalid GST',
    'GST must start with 2 digits, followed by 13 uppercase letters/numbers.',
    'error'
  );
  return;
}

  
  // Validate supplier
  const supplier = document.getElementById('supplierSelect').value;
  if (!supplier) {
    showMessage('Supplier Required', 'Please select a supplier.', 'warning');
    return;
  }
  
  const fileInput = document.getElementById('receiptFile');
  const file = fileInput.files[0];
  
  const rowData = [
    document.getElementById('academicYear').value,
    document.getElementById('date').value,
    supplier,
    document.getElementById('productName').value,
    gstNumber,
    document.getElementById('gstPercent').value,
    document.getElementById('totalAmount').value,
	document.getElementById('expensesAmount').value,
    document.getElementById('note').value,
    '__RECEIPT__'
  ];
  
  const payload = {
    action: "insert",
    spreadsheetId: CONFIG.spreadsheetId,
    dataSheet: CONFIG.dataSheet,
    driveFolderId: CONFIG.driveFolderId,
    rowData: rowData
  };
  
  loader.style.display = 'flex';
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      payload.receipt = {
        name: file.name,
        type: file.type,
        data: e.target.result.split(',')[1]
      };
      submitAddForm(payload);
    };
    reader.readAsDataURL(file);
  } else {
    submitAddForm(payload);
  }
});

function submitAddForm(payload) {
  fetch(scriptUrl, {
    method: "POST",
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(res => {
      loader.style.display = 'none';
      if (res.status === "success") {
        showMessage('Success', 'Stock receipt added successfully!', 'success');
        closeAddFormModal();
        // Refresh the data
        loadData();
      } else {
        showMessage('Submission Failed', res.message || 'Failed to submit data.', 'error');
      }
    })
    .catch(err => {
      loader.style.display = 'none';
      console.error(err);
      showMessage('Submission Failed', 'Failed to connect to server.', 'error');
    });
}

/*******************************
 * DELETE FUNCTIONALITY
 *******************************/
function openDeletePopup() {
  document.getElementById('deleteModal').style.display = 'block';
}

function closeDeletePopup() {
  document.getElementById('deleteModal').style.display = 'none';
}

function deleteRow() {
  closeDeletePopup();
  loader.style.display = 'flex';
  
  fetch(scriptUrl, {
    method: "POST",
    body: JSON.stringify({
      action: "delete",
      spreadsheetId: CONFIG.spreadsheetId,
      dataSheet: CONFIG.dataSheet,
      rowNumber: selectedRow
    })
  })
    .then(res => res.json())
    .then(() => {
      loader.style.display = 'none';
      showMessage('Success', 'Record deleted successfully!', 'success');
      loadData();
      showPage(1);
    })
    .catch(err => {
      loader.style.display = 'none';
      showMessage('Delete Failed', 'Failed to delete record. Please try again.', 'error');
      console.error(err);
    });
}

/*******************************
 * PAGE NAVIGATION
 *******************************/
function showPage(n) {
  // Hide all pages
  page1.classList.remove("active");
  page2.classList.remove("active");
  page3.classList.remove("active");
  
  // Show search only on page 1
  document.getElementById('searchContainer').style.display = n === 1 ? 'block' : 'none';
  
  // Show selected page
  if (n === 1) {
    page1.classList.add("active");
    // Clear search when returning to page 1
    searchBox.value = '';
    clearSearchBtn.style.display = 'none';
    filteredData = allData.slice(1);
    renderPage1();
  } else if (n === 2) {
    page2.classList.add("active");
  } else if (n === 3) {
    page3.classList.add("active");
  }
  
  // Smooth scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goToPage1() { 
  showPage(1); 
}

function goToPage2() { 
  // Only go to page 2 if we have selected row data
  if (selectedRowData) {
    showPage(2);
  } else {
    showMessage('Navigation Error', 'No record selected. Please select a record first.', 'warning');
    showPage(1);
  }
}

/*******************************
 * INITIAL LOAD
 *******************************/
document.addEventListener('DOMContentLoaded', function() {
  loadData();
  
  // Close modals when clicking outside
  window.addEventListener('click', function(event) {
    const modals = ['deleteModal', 'messageModal', 'supplierModal', 'addFormModal'];
    
    modals.forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (event.target === modal) {
        if (modalId === 'deleteModal') closeDeletePopup();
        if (modalId === 'messageModal') closeMessageModal();
        if (modalId === 'supplierModal') closeSupplierModal();
        if (modalId === 'addFormModal') closeAddFormModal();
      }
    });
  });
});
</script>
</body>

</html>
